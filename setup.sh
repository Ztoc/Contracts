#!/bin/bash
set -e
cd "$(dirname $0)"

[ "$#" -eq 1 ] || die "One Account ID argument required, $# provided"

export ACCOUNT_ID=$1

export SKYWARD_TOKEN_ID=token.$ACCOUNT_ID

near create-account $SKYWARD_TOKEN_ID --masterAccount=$ACCOUNT_ID --initialBalance=3
near deploy $SKYWARD_TOKEN_ID common/fungible_token.wasm new '{"owner_id": "'$ACCOUNT_ID'", "total_supply": "1000000000000000000000000", "metadata": {"spec": "ft-1.0.0", "name": "Test Skyward Finance Token", "symbol": "TEST_SKYWARD", "icon": "data:image/jpeg;base64,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", "decimals": 18}}'

export WRAP_NEAR_TOKEN_ID=wrap_near.$ACCOUNT_ID

near create-account $WRAP_NEAR_TOKEN_ID --masterAccount=$ACCOUNT_ID --initialBalance=3
near deploy $WRAP_NEAR_TOKEN_ID common/w_near.wasm new '{}'

near call $WRAP_NEAR_TOKEN_ID --accountId=$ACCOUNT_ID near_deposit '{}' --amount=10

export CONTRACT_ID=app.$ACCOUNT_ID

near create-account $CONTRACT_ID --masterAccount=$ACCOUNT_ID --initialBalance=4
near deploy $CONTRACT_ID skyward/res/skyward.wasm new '{"skyward_token_id": "'$SKYWARD_TOKEN_ID'", "skyward_total_supply": "1000000000000000000000000", "listing_fee_near": "10000000000000000000000000", "w_near_token_id": "'$WRAP_NEAR_TOKEN_ID'"}'

near call $SKYWARD_TOKEN_ID --accountId=$ACCOUNT_ID storage_deposit '{"account_id": "'$CONTRACT_ID'"}' --amount=0.00125
near call $WRAP_NEAR_TOKEN_ID --accountId=$ACCOUNT_ID storage_deposit '{"account_id": "'$CONTRACT_ID'"}' --amount=0.00125

export ALICE=alice.$ACCOUNT_ID
near create-account $ALICE --masterAccount=$ACCOUNT_ID --initialBalance=20

export BOB=bob.$ACCOUNT_ID
near create-account $BOB --masterAccount=$ACCOUNT_ID --initialBalance=20

export COBB=cobb.$ACCOUNT_ID
near create-account $COBB --masterAccount=$ACCOUNT_ID --initialBalance=20

near call $SKYWARD_TOKEN_ID --accountId=$ACCOUNT_ID ft_transfer '{"receiver_id": "'$CONTRACT_ID'", "amount": "900000000000000000000000"}' --amount=0.000000000000000000000001
export DATE=
near call $CONTRACT_ID --accountId=$CONTRACT_ID sale_create '{"sale": {
                "title": "SKYWARD sale",
                "url": "https://skyward.finance/sale",
                "out_tokens": [{
                  "token_account_id": "'$SKYWARD_TOKEN_ID'",
                  "balance": "900000000000000000000000"
                }],
                "in_token_account_id": "'$WRAP_NEAR_TOKEN_ID'",
                "start_time": "1621544319000000000",
                "duration": "31536000000000000"
            }}'
